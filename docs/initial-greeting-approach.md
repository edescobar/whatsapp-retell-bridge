# Initial Greeting Approach

## Current Implementation

The initial greeting "Hola. Soy Pilar, agente virtual del Banco de Córdoba. ¿Me comunico con {{name}}?" is **built by the workflow**, not generated by Retell AI.

## Why This Approach?

### Problem with Retell-Generated Greeting
- Retell's `/create-chat` endpoint only creates a session, doesn't return messages
- Retell's `/create-chat-completion` requires user input to generate response
- Sending "start" as a trigger would:
  - Add "start" to the conversation history
  - Potentially confuse the AI context
  - Create an extra API call

### Solution: Template-Based Greeting
The workflow builds the greeting directly:

```javascript
const greeting = `Hola. Soy Pilar, agente virtual del Banco de Córdoba. ¿Me comunico con ${customer_name}?`;
```

**Benefits**:
- ✅ Consistent greeting every time
- ✅ No extra API call to Retell
- ✅ Clean conversation history (doesn't include "start")
- ✅ Customer name is properly inserted
- ✅ Fast - no waiting for AI response

## Flow

```
Form Submit
  ↓
Create Retell Chat Session
  ├─ Sets dynamic variables: {name, amount, due_date, greeting}
  ├─ Variables available for ALL subsequent AI responses
  ↓
Store in Supabase
  ↓
Prepare Initial Greeting (build message with customer name)
  ↓
Send to WhatsApp (proactive first message)
  ↓
Customer Replies
  ↓
AI Responds (uses dynamic variables for context)
```

## When Retell AI Takes Over

After the initial greeting is sent:
1. Customer replies (e.g., "sí", "no", "hola")
2. Webhook receives message
3. Calls `/create-chat-completion` with customer's message
4. Retell AI responds using the dynamic variables:
   - `{{name}}` → "Ed"
   - `{{amount}}` → "1000.00"
   - `{{due_date}}` → "2025-10-30"

## Example Conversation

**Initial (from workflow)**:
```
Agent: Hola. Soy Pilar, agente virtual del Banco de Córdoba. ¿Me comunico con Ed?
```

**Customer replies**:
```
Customer: Sí
```

**AI responds (using dynamic variables)**:
```
Agent: Perfecto, Ed. Te escribo para recordarte que tenés un pago de $1000.00
que vence el día 2025-10-30. ¿Podemos contar con tu pago para esa fecha?
```

## Alternative: Retell-Generated Greeting

If you want Retell to generate the initial greeting instead:

1. **Set agent's "First Message"** in Retell Dashboard:
   ```
   Hola. Soy Pilar, agente virtual del Banco de Córdoba. ¿Me comunico con {{name}}?
   ```

2. **Modify workflow** to call `/create-chat-completion` with "start":
   ```json
   {
     "chat_id": "...",
     "content": "start"
   }
   ```

3. **Extract agent's response** from `messages` array

**Tradeoff**: Adds API call + conversation history starts with "start"